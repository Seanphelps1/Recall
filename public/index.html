<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOA Recall Notice Map</title>
    <style>
        #map {
            height: 750px;
            width: 100%;
        }
        #addressList {
            margin-top: 20px;
        }
        #legend {
            background: white;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #ccc;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwA7JIyB2oL1gudakLBTBfixAUZ_L1VUE&libraries=drawing,geometry"></script>
</head>
<body>
    <h1>HOA Recall Notice Map</h1>
    <div id="map"></div>
    <div id="legend">
        <h3>Legend</h3>
        <p><span style="color: green;">&#9679;</span> Green - Has either signed the sheet or declined to sign</p>
        <p><span style="color: red;">&#9679;</span> Red - No record of contact for recall sheet</p>
    </div>
    <ul id="addressList"></ul>
    
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "AIzaSyCwA7JIyB2oL1gudakLBTBfixAUZ_L1VUE",
        authDomain: "country-place-recall.firebaseapp.com",
        projectId: "country-place-recall",
        storageBucket: "country-place-recall.appspot.com",
        messagingSenderId: "564193307037",
        appId: "1:564193307037:web:4264759528343009d4a774",
        measurementId: "G-QSL43X9B2J"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); 

    let map;

    function initMap() {
        const neighborhoodBounds = {
            north: 28.1080,
            south: 28.0826,
            east: -82.5189,
            west: -82.5445,
        };

        const mapStyle = [
            { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.place_of_worship', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi.medical', stylers: [{ visibility: 'off' }] }
        ];

        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 28.095147, lng: -82.531077 },
            zoom: 15,
            restriction: { latLngBounds: neighborhoodBounds, strictBounds: true },
            gestureHandling: 'greedy',
            styles: mapStyle
        });

        map.setOptions({ disableDoubleClickZoom: true });

        // Load KML file and separate layers
        loadKmlProperties();

        // Fetch previously stored circles from Firestore
        fetchFirestoreData();
    }

    function fetchFirestoreData() {
        db.collection('addresses').get().then((querySnapshot) => {
            if (querySnapshot.empty) {
                console.log('No matching documents.');
                return;
            }

            querySnapshot.forEach((doc) => {
                const point = doc.data();
                console.log('Fetched from Firestore:', point);
                if (point.lat && point.lng) {
                    const latLng = new google.maps.LatLng(point.lat, point.lng);
                    createCircle(latLng, point.color || 'red');
                }
            });
            console.log('Firestore data successfully fetched and rendered on the map.');
        }).catch(error => {
            console.error('Error fetching Firestore data:', error);
        });
    }

    function loadKmlProperties() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://raw.githubusercontent.com/pheltech/Recall/refs/heads/main/public/Country%20Place%20Recall.kml?v=1", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xhr.responseText, "text/xml");
                    var placemarks = xmlDoc.getElementsByTagName("Placemark");

                    for (var i = 0; i < placemarks.length; i++) {
                        var placemark = placemarks[i];
                        var name = placemark.getElementsByTagName("name")[0].textContent;

                        if (name === "Country Place") {
                            // Load boundary polygon
                            var coords = placemark.getElementsByTagName("coordinates")[0].textContent.trim().split(/[\s\n]+/);
                            var boundaryCoords = [];
                            coords.forEach(coord => {
                                var latLng = coord.split(",");
                                if (latLng.length >= 2) {
                                    var lat = parseFloat(latLng[1]);
                                    var lng = parseFloat(latLng[0]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        boundaryCoords.push({ lat: lat, lng: lng });
                                    }
                                }
                            });
                            createPolygon(boundaryCoords);
                        } else if (name === "Houses") {
                            // Load house markers
                            var coordElements = placemark.getElementsByTagName("coordinates");
                            for (var j = 0; j < coordElements.length; j++) {
                                var coord = coordElements[j].textContent.trim().split(/[\s\n]+/)[0].split(",");
                                if (coord.length >= 2) {
                                    var lat = parseFloat(coord[1]);
                                    var lng = parseFloat(coord[0]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        storeInFirestoreIfNotExists({ lat: lat, lng: lng }, 'red');
                                    }
                                }
                            }
                        }
                    }
                } else {
                    console.warn("Failed to load KML data:", xhr.statusText);
                }
            }
        };
        xhr.send();
    }

    function createPolygon(paths) {
        const polygon = new google.maps.Polygon({
            paths: paths,
            strokeColor: 'blue',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillOpacity: 0,
            map: map
        });

        return polygon;
    }

    function createCircle(latLng, color) {
        console.log('Creating circle at:', latLng, 'with color:', color);
        const circle = new google.maps.Circle({
            strokeColor: color,
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: color,
            fillOpacity: 0.35,
            map: map,
            center: latLng,
            radius: 10
        });

        circle.addListener('click', () => {
            const newColor = circle.get('fillColor') === 'red' ? 'green' : 'red';
            circle.setOptions({ fillColor: newColor, strokeColor: newColor });

            updateFirestoreData(circle, newColor);
        });

        return circle;
    }

    function storeInFirestoreIfNotExists(latLng, color) {
        const docRef = db.collection('addresses').doc(`${latLng.lat}_${latLng.lng}`);
        
        docRef.get().then((docSnapshot) => {
            if (!docSnapshot.exists) {
                docRef.set({
                    lat: latLng.lat,
                    lng: latLng.lng,
                    color: color
                }).then(() => {
                    console.log('Firestore data successfully stored:', { lat: latLng.lat, lng: latLng.lng, color: color });
                }).catch(error => {
                    console.error('Error storing Firestore data:', error);
                });
            }
        }).catch(error => {
            console.error('Error checking Firestore document existence:', error);
        });
    }

    function updateFirestoreData(circle, newColor) {
        const latLng = circle.getCenter();
        const docRef = db.collection('addresses').doc(`${latLng.lat()}_${latLng.lng()}`);
        
        docRef.update({
            color: newColor
        }).then(() => {
            console.log('Firestore data successfully updated:', { lat: latLng.lat(), lng: latLng.lng(), color: newColor });
        }).catch(error => {
            console.error('Error updating Firestore data:', error);
        });
    }

    window.onload = initMap;
</script>
</body>
</html>
